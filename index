<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœ‰åŠ¹åŠ é€Ÿãƒã‚§ãƒƒã‚«ãƒ¼ v3.3 | ã‚¦ãƒå¨˜ãƒ—ãƒªãƒ†ã‚£ãƒ€ãƒ¼ãƒ“ãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700;900&family=Share+Tech+Mono&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Reset & Variables â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:        #070b11;
  --bg2:       #0b1020;
  --surface:   #0f1524;
  --surface2:  #131b2e;
  --surface3:  #18253c;
  --border:    #1c2840;
  --border2:   #243252;
  --gold:      #e8ba4a;
  --gold-dim:  #a07c28;
  --gold-glow: rgba(232,186,74,.15);
  --cyan:      #38c4f0;
  --green:     #38e08c;
  --purple:    #9e7de6;
  --red:       #e85050;
  --orange:    #e89040;
  --pink:      #e85888;
  --tx:        #d4e2f6;
  --tx2:       #6888b0;
  --tx3:       #384c6a;
  --mono:      'Share Tech Mono', monospace;
  --sans:      'Noto Sans JP', sans-serif;
  --disp:      'Zen Kaku Gothic New', sans-serif;
  --panel:     296px;
  --r:         8px;
  --r-sm:      5px;
}
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--tx);
  font-family: var(--sans);
  font-size: 13px;
  line-height: 1.6;
  min-height: 100vh;
}
/* èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse 70% 40% at 5% 0%, rgba(232,186,74,.05) 0%, transparent 60%),
    radial-gradient(ellipse 50% 60% at 95% 100%, rgba(56,196,240,.04) 0%, transparent 60%);
}

/* â”€â”€ Header â”€â”€ */
header {
  position: relative; z-index: 20;
  background: rgba(7,11,17,.9);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
}
.h-inner {
  max-width: 1440px; margin: 0 auto;
  padding: 12px 20px;
  display: flex; align-items: center; gap: 14px;
}
.h-logo { display: flex; flex-direction: column; gap: 1px; }
.h-title {
  font-family: var(--disp); font-weight: 900;
  font-size: 18px; letter-spacing: 3px;
  color: var(--gold); line-height: 1;
}
.h-sub { font-family: var(--mono); font-size: 9px; color: var(--tx3); letter-spacing: 1.5px; }
.h-sep { width: 1px; height: 30px; background: var(--border2); }
.h-tags { display: flex; gap: 5px; }
.h-tag {
  font-family: var(--mono); font-size: 9px; padding: 2px 7px;
  border-radius: 3px; letter-spacing: .5px;
}
.ht-g { background: var(--gold-glow); border: 1px solid rgba(232,186,74,.28); color: var(--gold); }
.ht-c { background: rgba(56,196,240,.06); border: 1px solid rgba(56,196,240,.18); color: var(--cyan); }
.h-right { margin-left: auto; }
.db-badge {
  font-family: var(--mono); font-size: 10px;
  padding: 3px 10px; border-radius: 4px;
  border: 1px solid var(--border); background: var(--surface); color: var(--tx3);
}
.db-badge b { color: var(--gold); }

/* â”€â”€ App Layout â”€â”€ */
.app {
  position: relative; z-index: 1;
  max-width: 1440px; margin: 0 auto;
  padding: 16px 16px;
  display: grid;
  grid-template-columns: var(--panel) 1fr;
  gap: 14px;
  align-items: start;
}

/* â”€â”€ Left Panel â”€â”€ */
.lpanel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  position: sticky; top: 14px;
  max-height: calc(100vh - 28px);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}
.lpanel::-webkit-scrollbar { width: 3px; }
.lpanel::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.psec {
  padding: 13px 15px;
  border-bottom: 1px solid var(--border);
}
.psec:last-child { border-bottom: none; }
.psec-ttl {
  font-family: var(--mono); font-size: 8.5px;
  letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--tx3); margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.psec-ttl::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* Form */
.fg { margin-bottom: 9px; }
.fg:last-child { margin-bottom: 0; }
label {
  display: block; font-size: 10px; color: var(--tx2);
  margin-bottom: 3px; letter-spacing: .3px;
}
label.req::after { content: ' âœ¦'; color: var(--gold); font-size: 8px; }

select, input[type=number] {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  color: var(--tx); padding: 6px 9px;
  font-family: var(--sans); font-size: 12px;
  outline: none; appearance: none;
  transition: border-color .14s, box-shadow .14s;
}
select:focus, input[type=number]:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(232,186,74,.08);
}
select option { background: var(--surface2); }
.err { font-size: 9.5px; color: var(--red); margin-top: 2px; display: none; }
.err.show { display: block; }
.err-ring { border-color: var(--red) !important; }

/* Toggle Buttons */
.tbs { display: flex; gap: 3px; flex-wrap: wrap; }
.tb {
  flex: 1; min-width: 0;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r-sm); color: var(--tx3);
  padding: 5px 3px; cursor: pointer;
  font-family: var(--sans); font-size: 11px;
  text-align: center; transition: all .11s;
  white-space: nowrap;
}
.tb:hover { border-color: var(--border2); color: var(--tx2); }
.tb.on { background: rgba(232,186,74,.1); border-color: var(--gold); color: var(--gold); font-weight: 700; }

/* Slope */
.slope-wrap {
  border: 1px solid rgba(232,186,74,.1);
  border-radius: var(--r-sm);
  background: rgba(232,186,74,.02);
  padding: 9px 10px; margin-top: 2px;
}
.slope-kind { font-size: 10px; color: var(--tx2); margin-bottom: 4px; margin-top: 8px; }
.slope-kind:first-of-type { margin-top: 0; }
.srow { display: flex; align-items: center; gap: 3px; margin-bottom: 3px; }
.srow input { flex: 1; padding: 4px 6px; font-size: 11px; }
.sep-txt { font-size: 10px; color: var(--tx3); flex-shrink: 0; }
.rm { background: transparent; border: none; color: var(--tx3); cursor: pointer; font-size: 13px; padding: 0 2px; transition: color .1s; flex-shrink: 0; }
.rm:hover { color: var(--red); }
.add {
  width: 100%; background: transparent;
  border: 1px dashed rgba(232,186,74,.18);
  border-radius: 4px; color: rgba(232,186,74,.35);
  padding: 3px; font-family: var(--sans); font-size: 10px;
  cursor: pointer; transition: all .12s; margin-top: 2px;
}
.add:hover { border-color: var(--gold); color: var(--gold); }
.hint { font-size: 9.5px; color: var(--tx3); margin-top: 4px; line-height: 1.5; }

.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 8px; }
.g2 .fg { margin-bottom: 0; }

/* Buttons */
.btn-search {
  width: 100%;
  background: linear-gradient(135deg, #eac050 0%, #b87020 100%);
  border: none; border-radius: var(--r-sm);
  color: #04070d; padding: 9px;
  font-family: var(--disp); font-size: 13px; font-weight: 900;
  cursor: pointer; letter-spacing: 1.5px;
  transition: all .15s; margin-top: 4px;
  position: relative; overflow: hidden;
}
.btn-search::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,.14) 0%, transparent 50%);
}
.btn-search:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(232,186,74,.22); }
.btn-search:active { transform: translateY(0); }
.btn-reset {
  width: 100%; background: transparent;
  border: 1px solid var(--border); border-radius: var(--r-sm);
  color: var(--tx3); padding: 6px;
  font-family: var(--sans); font-size: 11px;
  cursor: pointer; transition: all .12s; margin-top: 4px;
}
.btn-reset:hover { border-color: var(--tx3); color: var(--tx2); }

/* â”€â”€ Right Panel â”€â”€ */
.rpanel { display: flex; flex-direction: column; gap: 10px; }

.res-hd { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
.res-num {
  font-family: var(--disp); font-weight: 900;
  font-size: 34px; color: var(--gold); line-height: 1;
}
.res-lbl { font-size: 10px; color: var(--tx3); letter-spacing: .5px; }
.res-tot { font-size: 11px; color: var(--tx2); }

.chips { display: flex; gap: 4px; flex-wrap: wrap; min-height: 20px; }
.chip {
  font-family: var(--mono); font-size: 10px;
  padding: 2px 7px; border-radius: 3px;
  background: rgba(232,186,74,.06);
  border: 1px solid rgba(232,186,74,.16);
  color: var(--gold);
  animation: ci .18s ease;
}
@keyframes ci { from { opacity:0; transform:scale(.8); } to { opacity:1; transform:scale(1); } }

.legend {
  display: flex; gap: 10px; flex-wrap: wrap;
  align-items: center; padding: 7px 12px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r-sm); font-size: 10px; color: var(--tx2);
}
.li { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
.ld { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

.warn-box {
  display: none; padding: 7px 12px;
  background: rgba(232,144,64,.06);
  border: 1px solid rgba(232,144,64,.2);
  border-radius: var(--r-sm);
  font-size: 10px; color: var(--orange); line-height: 1.5;
}
.warn-box.show { display: block; }

/* Table */
.tbl-outer {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); overflow: hidden; overflow-x: auto;
}
table { width: 100%; border-collapse: collapse; min-width: 820px; }
thead tr { background: var(--surface2); border-bottom: 1px solid var(--border2); }
th {
  padding: 8px 12px; text-align: left;
  font-family: var(--mono); font-size: 9px;
  letter-spacing: 1.5px; color: var(--tx3);
  white-space: nowrap; font-weight: 400;
}
td {
  padding: 8px 12px; border-bottom: 1px solid rgba(28,40,64,.4);
  vertical-align: top;
}
tr:last-child td { border-bottom: none; }
tbody tr:hover td { background: rgba(255,255,255,.012); }
tr.invalid { opacity: .2; }
.c-name { font-size: 12px; font-weight: 500; color: var(--tx); min-width: 130px; }
.c-eff { font-size: 11px; color: var(--tx2); max-width: 250px; min-width: 130px; line-height: 1.5; }
.c-rank { font-size: 11px; color: var(--tx2); white-space: nowrap; }

/* Badges */
.badge {
  display: inline-flex; align-items: center;
  padding: 3px 8px; border-radius: 4px;
  font-family: var(--mono); font-size: 10px;
  white-space: nowrap; line-height: 1.3;
}
.b-fast   { background: rgba(56,224,140,.1);  color: var(--green);  border: 1px solid rgba(56,224,140,.22); }
.b-semi   { background: rgba(56,196,240,.1);  color: var(--cyan);   border: 1px solid rgba(56,196,240,.22); }
.b-rand   { background: rgba(158,125,230,.1); color: var(--purple); border: 1px solid rgba(158,125,230,.22); }
.b-slope  { background: rgba(232,186,74,.1);  color: var(--gold);   border: 1px solid rgba(232,186,74,.22); }
.b-slopex { background: rgba(232,80,80,.07);  color: #c02828;       border: 1px solid rgba(232,80,80,.18); }
.b-inv    { background: rgba(36,50,82,.15);   color: var(--tx3);    border: 1px solid var(--border); }
.b-always { background: rgba(56,224,140,.06);  color: #80ffb0;       border: 1px solid rgba(56,224,140,.18); }

/* Rarity Badges */
.rar-badge {
  display: inline-flex; align-items: center;
  padding: 2px 7px; border-radius: 4px;
  font-family: var(--mono); font-size: 10px;
  white-space: nowrap; line-height: 1.3;
  font-weight: 700;
}
.rar-w  { background: rgba(180,180,180,.08); color: #a0aabb; border: 1px solid rgba(160,160,160,.2); }
.rar-g  { background: rgba(245,200,66,.12); color: #f5c842; border: 1px solid rgba(245,200,66,.3); }
.rar-ub { background: rgba(126,184,247,.12); color: #7eb8f7; border: 1px solid rgba(126,184,247,.3); }
.rar-u  { background: rgba(200,132,245,.12); color: #c884f5; border: 1px solid rgba(200,132,245,.3); }
.rar-e  { background: rgba(255,140,66,.14); color: #ff8c42; border: 1px solid rgba(255,140,66,.3); }

/* Empty */
.empty {
  padding: 56px 20px; text-align: center; color: var(--tx3);
}
.empty-icon { font-size: 44px; opacity: .2; margin-bottom: 12px; }
.empty p { font-size: 12px; line-height: 2; }
.empty b { color: var(--tx2); }
.no-res { padding: 44px 20px; text-align: center; color: var(--tx3); font-size: 12px; }

/* Responsive */
@media (max-width: 860px) {
  .app { grid-template-columns: 1fr; padding: 8px; }
  .lpanel { position: static; max-height: none; }
  .h-tags { display: none; }
}

/* â”€â”€ Uncertainty Badges â”€â”€ */
.u-zero { background:rgba(56,224,140,.12); color:#38e08c; border:1px solid rgba(56,224,140,.3); }
.u-low  { background:rgba(56,196,240,.1);  color:#38c4f0; border:1px solid rgba(56,196,240,.28); }
.u-mid  { background:rgba(232,186,74,.1);  color:#e8ba4a; border:1px solid rgba(232,186,74,.3); }
.u-high { background:rgba(232,144,64,.1);  color:#e89040; border:1px solid rgba(232,144,64,.3); }
.u-vhigh{ background:rgba(232,80,80,.1);   color:#e85050; border:1px solid rgba(232,80,80,.3); }
.unc-badge {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 8px; border-radius:4px;
  font-family:var(--mono); font-size:10px; white-space:nowrap; line-height:1.3;
}
.unc-score { font-weight:900; font-size:12px; }
.cond-tags { display:flex; flex-wrap:wrap; gap:2px; margin-top:3px; }
.cond-tag {
  font-family:var(--mono); font-size:8px; padding:1px 5px;
  border-radius:3px; white-space:nowrap;
}
.ct-rrw{ background:rgba(220,210,60,.1);  border:1px solid rgba(220,210,60,.25);  color:#c8b820; }
.ct-rr { background:rgba(232,144,64,.1); border:1px solid rgba(232,144,64,.25); color:#e89040; }
.ct-rv { background:rgba(232,80,80,.1);  border:1px solid rgba(232,80,80,.25);  color:#e85050; }
.c-chara {
  font-size: 10px; color: var(--purple); margin-top: 3px;
  font-style: italic; line-height: 1.4;
}
.rank-cr { color: var(--cyan); font-family: var(--mono); font-size: 10px; }
.rank-lr { color: var(--gold); font-family: var(--mono); font-size: 10px; }
.rank-sep { color: var(--tx3); font-size: 10px; }


  .sort-bar {font-family:var(--mono); font-size:9px; color:var(--tx3);
  padding:5px 14px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:6px; flex-wrap:wrap;
}
.sort-bar .sbl { color:var(--tx2); }

</style>
</head>
<body>

<header>
  <div class="h-inner">
    <div class="h-logo">
      <div class="h-title">VALID ACCEL CHECKER</div>
      <div class="h-sub">æœ‰åŠ¹åŠ é€Ÿãƒã‚§ãƒƒã‚«ãƒ¼ â€” ã‚¦ãƒå¨˜ãƒ—ãƒªãƒ†ã‚£ãƒ€ãƒ¼ãƒ“ãƒ¼</div>
    </div>
    <div class="h-sep"></div>
    <div class="h-tags">
      <span class="h-tag ht-g">åŠ¹æœã‚³ãƒ¼ãƒ‰31 åŠ é€Ÿã‚¹ã‚­ãƒ«</span>
      <span class="h-tag ht-c">ä¸ç¢ºå®Ÿæ€§ã‚¹ã‚³ã‚¢åˆ†æ v3.3</span>
    </div>
    <div class="h-right">
      <div class="db-badge">DB: <b id="dbCnt">â€”</b> ã‚¹ã‚­ãƒ«</div>
    </div>
  </div>
</header>

<div class="app">

  <!-- â”â” LEFT PANEL â”â” -->
  <div class="lpanel">

    <div class="psec">
      <div class="psec-ttl">ãƒ¬ãƒ¼ã‚¹ãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
      <div class="fg">
        <label>ãƒ¬ãƒ¼ã‚¹é¸æŠï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
        <select id="presetSel" onchange="applyPreset()">
          <option value="">â€• ãƒ¬ãƒ¼ã‚¹ã‚’é¸ã¶ â€•</option>
        </select>
      </div>
    </div>

    <div class="psec">
      <div class="psec-ttl">å¿…é ˆæ¡ä»¶</div>

      <div class="fg">
        <label class="req">è·é›¢</label>
        <select id="distSel" onchange="onDistChange()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <div class="err" id="e-dist">è·é›¢ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="fg">
        <label class="req">ãƒå ´</label>
        <div class="tbs">
          <button class="tb" data-g="gt" data-v="1" onclick="tog(this)">èŠ</button>
          <button class="tb" data-g="gt" data-v="2" onclick="tog(this)">ãƒ€ãƒ¼ãƒˆ</button>
        </div>
        <div class="err" id="e-gt">ãƒå ´ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="fg">
        <label class="req">ãƒå ´çŠ¶æ…‹</label>
        <div class="tbs">
          <button class="tb" data-g="gc" data-v="1" onclick="tog(this)">è‰¯</button>
          <button class="tb" data-g="gc" data-v="2" onclick="tog(this)">ç¨é‡</button>
          <button class="tb" data-g="gc" data-v="3" onclick="tog(this)">é‡</button>
          <button class="tb" data-g="gc" data-v="4" onclick="tog(this)">ä¸è‰¯</button>
        </div>
        <div class="err" id="e-gc">ãƒå ´çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="fg">
        <label class="req">ãƒ¬ãƒ¼ã‚¹å ´</label>
        <select id="venueSel">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <div class="err" id="e-venue">ãƒ¬ãƒ¼ã‚¹å ´ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
    </div>

    <div class="psec">
      <div class="psec-ttl">ä»»æ„æ¡ä»¶</div>
      <div class="fg">
        <label>ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼ˆæœªé¸æŠï¼å…¨å¯¾å¿œï¼‰</label>
        <div class="tbs">
          <button class="tb" data-g="mv" data-v="1" onclick="togMv(this)" style="font-size:10px">çµ¶ä¸èª¿</button>
          <button class="tb" data-g="mv" data-v="2" onclick="togMv(this)" style="font-size:10px">ä¸èª¿</button>
          <button class="tb" data-g="mv" data-v="3" onclick="togMv(this)" style="font-size:10px">æ™®é€š</button>
          <button class="tb" data-g="mv" data-v="4" onclick="togMv(this)" style="font-size:10px">å¥½èª¿</button>
          <button class="tb" data-g="mv" data-v="5" onclick="togMv(this)" style="font-size:10px">çµ¶å¥½èª¿</button>
        </div>
      </div>
    </div>

    <div class="psec">
      <div class="psec-ttl">ãƒ¬ã‚¢åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
      <div class="fg">
        <label>ãƒ¬ã‚¢åº¦ï¼ˆæœªé¸æŠï¼å…¨ã¦è¡¨ç¤ºï¼‰</label>
        <div class="tbs" style="flex-wrap:wrap">
          <button class="tb rar-tb" data-rar="1" onclick="togRar(this)" style="font-size:10px;color:#aaa">ç™½</button>
          <button class="tb rar-tb" data-rar="2" onclick="togRar(this)" style="font-size:10px;color:#f5c842">é‡‘</button>
          <button class="tb rar-tb" data-rar="3" onclick="togRar(this)" style="font-size:10px;color:#7eb8f7">å›ºæœ‰ä¸‹</button>
          <button class="tb rar-tb" data-rar="4" onclick="togRar(this)" style="font-size:10px;color:#c884f5">å›ºæœ‰</button>
          <button class="tb rar-tb" data-rar="6" onclick="togRar(this)" style="font-size:10px;color:#ff8c42">é€²åŒ–</button>
        </div>
      </div>
    </div>

    <div class="psec">
      <div class="psec-ttl">ã‚³ãƒ¼ã‚¹è©³ç´°</div>

      <div class="g2">
        <div class="fg">
          <label>çµ‚ç›¤é–‹å§‹ ls (m)</label>
          <input type="number" id="manLS" placeholder="ä¾‹:1333" min="0" max="3200">
        </div>
        <div class="fg">
          <label>æœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼ fc (m)</label>
          <input type="number" id="manFC" placeholder="ä¾‹:1230" min="0" max="3200">
        </div>
      </div>
      <div class="fg">
        <label>æœ€çµ‚ç›´ç·š fs (m)</label>
        <input type="number" id="manFS" placeholder="ä¾‹:1500" min="0" max="3200">
      </div>

      <div class="slope-wrap">
        <div class="slope-kind">â›° ä¸Šã‚Šå‚åŒºé–“</div>
        <div id="upRows"></div>
        <button class="add" onclick="addSlope('up')">ï¼‹ åŒºé–“ã‚’è¿½åŠ </button>
        <div class="slope-kind" style="margin-top:10px">â¬‡ ä¸‹ã‚Šå‚åŒºé–“</div>
        <div id="dnRows"></div>
        <button class="add" onclick="addSlope('dn')">ï¼‹ åŒºé–“ã‚’è¿½åŠ </button>
      </div>
      <p class="hint">ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã§è‡ªå‹•å…¥åŠ›ã€‚æ‰‹å‹•ä¸Šæ›¸ãå¯ã€‚</p>
    </div>

    <div class="psec">
      <button class="btn-search" onclick="doSearch()">ğŸ” æœ‰åŠ¹åŠ é€Ÿã‚’æ¤œç´¢</button>
      <button class="btn-reset" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

  </div>

  <!-- â”â” RIGHT PANEL â”â” -->
  <div class="rpanel">

    <div class="res-hd">
      <div class="res-num" id="resCnt">â€”</div>
      <div>
        <div class="res-lbl">ä»¶ã®æœ‰åŠ¹åŠ é€Ÿã‚¹ã‚­ãƒ«</div>
        <div class="res-tot" id="resTot"></div>
      </div>
    </div>

    <div class="chips" id="chips"></div>

    <div class="legend">
      <span style="font-family:var(--mono);font-size:8px;letter-spacing:1.5px;color:var(--tx3);margin-right:2px">LEGEND</span>
      <span class="li"><span class="ld" style="background:var(--green)"></span>æœ€é€Ÿç™ºå‹•</span>
      <span class="li"><span class="ld" style="background:var(--cyan)"></span>æº–é€Ÿç™ºå‹•</span>
      <span class="li"><span class="ld" style="background:var(--purple)"></span>ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹</span>
      <span class="li"><span class="ld" style="background:var(--gold)"></span>å‚ï¼ˆæœ‰åŠ¹ï¼‰</span>
      <span class="li"><span class="ld" style="background:#c02828"></span>å‚ï¼ˆç„¡åŠ¹ï¼‰</span>
      <span class="li"><span class="ld" style="background:#80ffb0"></span>å¸¸æ™‚æœ‰åŠ¹</span>
      <span class="li"><span class="ld" style="background:var(--tx3)"></span>ç„¡åŠ¹</span>
      <span style="margin-left:8px;border-left:1px solid var(--border);padding-left:8px;color:var(--tx3);font-size:9px">ä¸ç¢ºå®Ÿæ€§:</span>
      <span class="li"><span class="ld" style="background:#38e08c"></span>ç¢ºå®š(0)</span>
      <span class="li"><span class="ld" style="background:#38c4f0"></span>ä½(1)</span>
      <span class="li"><span class="ld" style="background:#e8ba4a"></span>ä¸­(2)</span>
      <span class="li"><span class="ld" style="background:#e89040"></span>é«˜(3+)</span>
    </div>

    <div class="warn-box" id="warnBox">
      âš  æœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼ï¼ˆfcï¼‰ã¾ãŸã¯æœ€çµ‚ç›´ç·šï¼ˆfsï¼‰ãŒæœªå…¥åŠ›ã§ã™ã€‚
      è©²å½“ã‚¹ã‚­ãƒ«ã®åˆ¤å®šç²¾åº¦ãŒä¸‹ãŒã‚Šã¾ã™ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã¾ãŸã¯ã‚³ãƒ¼ã‚¹è©³ç´°ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="tbl-outer">
      <div id="resBody">
        <div class="empty">
          <div class="empty-icon">ğŸ‡</div>
          <p>
            <b>è·é›¢ãƒ»ãƒå ´ãƒ»ãƒå ´çŠ¶æ…‹ãƒ»ãƒ¬ãƒ¼ã‚¹å ´</b>ã‚’é¸æŠã—ã¦<br>
            æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„<br>
            <span style="font-size:10px;color:var(--tx3)">ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰ãƒ¬ãƒ¼ã‚¹ã‚’é¸ã¶ã¨å…¨è‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™</span>
          </p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â”€â”€ Data files â”€â”€ -->
<script src="const_RACES.js"></script>
<script src="const_SKILL_CHARA.js"></script>
<script src="const_SKILLS.js"></script>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONSTANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DT_LABEL = {1:'çŸ­è·é›¢',2:'ãƒã‚¤ãƒ«',3:'ä¸­è·é›¢',4:'é•·è·é›¢'};
const GT_LABEL = {1:'èŠ',2:'ãƒ€ãƒ¼ãƒˆ'};
const GC_LABEL = {1:'è‰¯',2:'ç¨é‡',3:'é‡',4:'ä¸è‰¯'};
const MV_LABEL = {1:'çµ¶ä¸èª¿',2:'ä¸èª¿',3:'æ™®é€š',4:'å¥½èª¿',5:'çµ¶å¥½èª¿'};

const VENUE_TRACKS = {
  'æ±äº¬':[10005],'ä¸­å±±':[10006],'äº¬éƒ½':[10008],'é˜ªç¥':[10009],'ä¸­äº¬':[10007],
  'å¤§äº•':[10101],'å·å´':[10102],'èˆ¹æ©‹':[10103],'ç››å²¡':[10104],
  'æœ­å¹Œ':[10001],'å‡½é¤¨':[10002],'ç¦å³¶':[10003],'æ–°æ½Ÿ':[10004],
  'å°å€‰':[10010],'ä½è³€':[10201],
  'ã‚µãƒ³ã‚¿ã‚¢ãƒ‹ã‚¿ãƒ‘ãƒ¼ã‚¯':[10202],'ãƒ‡ãƒ«ãƒãƒ¼':[10203]
};
const VENUES = ['æ±äº¬','ä¸­å±±','äº¬éƒ½','é˜ªç¥','ä¸­äº¬','å¤§äº•','å·å´','èˆ¹æ©‹','ç››å²¡'];

function getDistType(d){ return d<=1599?1:d<=1999?2:d<=2499?3:4; }

let uCnt=0, dCnt=0;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function init(){
  document.getElementById('dbCnt').textContent = SKILLS.length;

  // è·é›¢
  const ds = document.getElementById('distSel');
  for(let d=1200;d<=3200;d+=100){
    const o=document.createElement('option');
    o.value=d; o.textContent=`${d}mï¼ˆ${DT_LABEL[getDistType(d)]}ï¼‰`;
    ds.appendChild(o);
  }

  // ä¼šå ´
  const vs = document.getElementById('venueSel');
  const jra=['æ±äº¬','ä¸­å±±','äº¬éƒ½','é˜ªç¥','ä¸­äº¬'];
  const chiho=['å¤§äº•','å·å´','èˆ¹æ©‹','ç››å²¡'];
  const kaigai=['ã‚µãƒ³ã‚¿ã‚¢ãƒ‹ã‚¿ãƒ‘ãƒ¼ã‚¯','ãƒ‡ãƒ«ãƒãƒ¼'];
  function addVG(label, arr){
    const g=document.createElement('optgroup'); g.label=label;
    arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; g.appendChild(o); });
    vs.appendChild(g);
  }
  addVG('JRA',jra); addVG('åœ°æ–¹',chiho); addVG('æµ·å¤–',kaigai);

  // ãƒ—ãƒªã‚»ãƒƒãƒˆ
  const ps = document.getElementById('presetSel');
  const preJRA=[], preChiho=[], preKaigai=[];
  RACES.forEach((r,i)=>{
    const isJ = ['æ±äº¬','ä¸­å±±','äº¬éƒ½','é˜ªç¥','ä¸­äº¬'].includes(r.venue);
    const isK = ['ã‚µãƒ³ã‚¿ã‚¢ãƒ‹ã‚¿ãƒ‘ãƒ¼ã‚¯','ãƒ‡ãƒ«ãƒãƒ¼'].includes(r.venue);
    (isJ?preJRA:isK?preKaigai:preChiho).push({r,i});
  });
  function addPG(label, arr){
    const g=document.createElement('optgroup'); g.label=label;
    arr.forEach(({r,i})=>{
      const o=document.createElement('option'); o.value=i;
      o.textContent=`${r.name}ï¼ˆ${r.venue} ${r.distance}m/${GT_LABEL[r.gt]}ï¼‰`;
      g.appendChild(o);
    });
    ps.appendChild(g);
  }
  addPG('JRA',preJRA); addPG('åœ°æ–¹',preChiho); addPG('æµ·å¤–',preKaigai);
})();


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UI HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let rarFilter = new Set(); // ç©º=å…¨è¡¨ç¤º
function togRar(btn){
  const v = parseInt(btn.dataset.rar);
  if(rarFilter.has(v)){ rarFilter.delete(v); btn.classList.remove('on'); }
  else { rarFilter.add(v); btn.classList.add('on'); }
}

function tog(btn){
  document.querySelectorAll(`[data-g="${btn.dataset.g}"]`).forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
}
let mvVal = null;
function togMv(btn){
  const v = parseInt(btn.dataset.v);
  if(mvVal===v){ btn.classList.remove('on'); mvVal=null; }
  else {
    document.querySelectorAll('[data-g="mv"]').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on'); mvVal=v;
  }
}
function getSel(g){ const b=document.querySelector(`[data-g="${g}"].on`); return b?parseInt(b.dataset.v):null; }

function clearErr(){
  document.querySelectorAll('.err').forEach(e=>e.classList.remove('show'));
  document.querySelectorAll('.err-ring').forEach(e=>e.classList.remove('err-ring'));
}
function showErr(eid, eid2){
  document.getElementById(eid).classList.add('show');
  if(eid2) document.getElementById(eid2).classList.add('err-ring');
}

/* å‚è¡Œ */
function addSlope(t){ addSlopeRow(t,'',''); }
function addSlopeRow(t,s,e){
  const cont=document.getElementById(t==='up'?'upRows':'dnRows');
  const id=t==='up'?++uCnt:++dCnt;
  const rid=`${t}_${id}`;
  const div=document.createElement('div'); div.className='srow'; div.id=`row_${rid}`;
  div.innerHTML=`<input type="number" id="${rid}_s" value="${s||''}" placeholder="é–‹å§‹m" min="0" max="3200">`
    +`<span class="sep-txt">ã€œ</span>`
    +`<input type="number" id="${rid}_e" value="${e||''}" placeholder="çµ‚äº†m" min="0" max="3200">`
    +`<button class="rm" onclick="this.closest('.srow').remove()" title="å‰Šé™¤">âœ•</button>`;
  cont.appendChild(div);
}
function getSlopes(t){
  const res=[];
  document.getElementById(t==='up'?'upRows':'dnRows').querySelectorAll('.srow').forEach(row=>{
    const ins=row.querySelectorAll('input');
    const s=parseFloat(ins[0].value), e=parseFloat(ins[1].value);
    if(!isNaN(s)&&!isNaN(e)&&s<e) res.push([s,e]);
  });
  return res;
}

/* ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨ */
function applyPreset(){
  const idx=document.getElementById('presetSel').value;
  if(idx==='') return;
  const r=RACES[parseInt(idx)];
  document.getElementById('distSel').value=r.distance;
  document.querySelectorAll('[data-g="gt"]').forEach(b=>b.classList.remove('on'));
  const gb=document.querySelector(`[data-g="gt"][data-v="${r.gt}"]`);
  if(gb) gb.classList.add('on');
  document.getElementById('venueSel').value=r.venue;
  document.getElementById('manLS').value=r.ls;
  document.getElementById('manFC').value=r.fc;
  document.getElementById('manFS').value=r.fs;
  document.getElementById('upRows').innerHTML='';
  document.getElementById('dnRows').innerHTML='';
  uCnt=0; dCnt=0;
  (r.us||[]).forEach(([s,e])=>addSlopeRow('up',s,e));
  (r.ds||[]).forEach(([s,e])=>addSlopeRow('dn',s,e));
  clearErr();
}

/* è·é›¢å¤‰æ›´æ™‚ã«lsã‚’è‡ªå‹•è£œå®Œ */
function onDistChange(){
  const d=parseInt(document.getElementById('distSel').value)||0;
  if(!d) return;
  const ls=document.getElementById('manLS');
  if(!ls.value) ls.value=Math.floor(d*2/3);
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UNCERTAINTY SCORING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// ãƒ¬ãƒ¼ã‚¹é‹ã³æ¡ä»¶(å¼±)ã«åˆ†é¡ã•ã‚ŒãŸå†…éƒ¨å¤‰æ•°
const RR_WEAK_VARS = new Set([
  'infront_near_lane_time',
  'behind_near_lane_time'
]);

// å›ºå®šæ¡ä»¶ã«å†åˆ†é¡ã•ã‚ŒãŸå†…éƒ¨å¤‰æ•°ï¼ˆrrãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å«ã¾ã‚Œã¦ã„ã¦ã‚‚ã‚¹ã‚³ã‚¢åŠ ç®—ã—ãªã„ï¼‰
const FIXED_RR_VARS = new Set([
  'hp_per',
  'order',
  'order_rate'
]);

// å›ºå®šæ¡ä»¶ã«å†åˆ†é¡ã•ã‚ŒãŸå†…éƒ¨å¤‰æ•°ï¼ˆrvãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å´ï¼‰
const FIXED_RV_VARS = new Set([
  'popularity'
]);

// ã‚¹ã‚­ãƒ«ã®uncã‚’æ–°ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã§å‹•çš„è¨ˆç®—
function calcUnc(s) {
  let score = 0;
  // ãƒ©ãƒ³ãƒ€ãƒ æ¡ä»¶ +4ï¼ˆå›ºå®šæ¡ä»¶ã«å†åˆ†é¡ã•ã‚ŒãŸã‚‚ã®ã¯é™¤å¤–ï¼‰
  (s.rv || []).forEach(v => {
    if (!FIXED_RV_VARS.has(v)) score += 4;
  });
  // ãƒ¬ãƒ¼ã‚¹é‹ã³æ¡ä»¶ or (å¼±) or å›ºå®šæ¡ä»¶ã®åˆ†é¡
  (s.rr || []).forEach(v => {
    if (FIXED_RR_VARS.has(v)) {
      score += 0; // å›ºå®šæ¡ä»¶ Â±0
    } else if (RR_WEAK_VARS.has(v)) {
      score += 1; // ãƒ¬ãƒ¼ã‚¹é‹ã³æ¡ä»¶(å¼±) +1
    } else {
      score += 2; // ãƒ¬ãƒ¼ã‚¹é‹ã³æ¡ä»¶ +2
    }
  });
  return score;
}



function judgeOffset(off, label_suffix) {
  const suf = label_suffix ? ' ' + label_suffix : '';
  if (off >= -50 && off <= 0) {
    const lbl = off === 0 ? 'æœ€é€Ÿç™ºå‹• (ls)' : `æœ€é€Ÿç™ºå‹• (${Math.abs(Math.round(off))}må‰)`;
    return {valid:true, cls:'b-fast', label:lbl + suf, pri:0};
  }
  if (off > 0 && off <= 100)
    return {valid:true, cls:'b-semi', label:`æº–é€Ÿç™ºå‹• (+${Math.round(off)}m)` + suf, pri:1};
  if (off < -50)
    return {valid:false, cls:'b-inv', label:`ç„¡åŠ¹ï¼ˆæ—©æœŸ ${Math.abs(Math.round(off))}må‰ï¼‰` + suf, pri:90};
  return {valid:false, cls:'b-inv', label:`ç„¡åŠ¹ï¼ˆé…å»¶ +${Math.round(off)}mï¼‰` + suf, pri:91};
}

function calcSegTiming(tm, rc) {
  const {ls, fc, fs, distance, us, ds} = rc;

  if (tm.type === 'always')
    return {valid:true, cls:'b-always', label:'å¸¸æ™‚æœ‰åŠ¹', pri:2};

  if (tm.type === 'exclude')
    return null; // excluded segment

  // â”€â”€ Fixed timing â”€â”€
  if (tm.type === 'fixed') {
    let fp = null, suffix = '';
    switch (tm.fixed_point) {
      case 'ls':
        fp = ls; break;

      case 'finalcorner':
        // fires at fc â€” works whether fc is before or after ls
        if (fc == null)
          return {valid:true, cls:'b-rand', label:'ã‚³ãƒ¼ã‚¹æƒ…å ±ä¸è¶³ï¼ˆfcæœªå…¥åŠ›ï¼‰', pri:50};
        fp = fc;
        suffix = fc < ls ? 'ï¼ˆä¸­ç›¤ã‚³ãƒ¼ãƒŠãƒ¼ï¼‰' : 'ï¼ˆçµ‚ç›¤ã‚³ãƒ¼ãƒŠãƒ¼ï¼‰';
        break;

      case 'finalstraight':
        if (fs == null)
          return {valid:true, cls:'b-rand', label:'ã‚³ãƒ¼ã‚¹æƒ…å ±ä¸è¶³ï¼ˆfsæœªå…¥åŠ›ï¼‰', pri:50};
        fp = fs;
        break;

      case 'remain':
        fp = distance - tm.rv;
        break;

      case 'distance_rate':
        fp = Math.floor(distance * tm.rv / 100);
        break;

      // â”€â”€ NEW: phase>=2 & corner!=0 â”€â”€
      case 'phase2_corner':
        // fires when horse enters a corner during final phase
        // if fc >= ls: horse hasn't reached the final corner yet â†’ fires at fc
        // if fc < ls:  horse is already in the final corner when phase2 starts â†’ fires at ls
        if (fc == null)
          return {valid:true, cls:'b-rand', label:'ã‚³ãƒ¼ã‚¹æƒ…å ±ä¸è¶³ï¼ˆfcæœªå…¥åŠ›ï¼‰', pri:50};
        fp = (fc >= ls) ? fc : ls;
        suffix = (fc >= ls) ? 'ï¼ˆçµ‚ç›¤ã‚³ãƒ¼ãƒŠãƒ¼å…¥å£ï¼‰' : 'ï¼ˆlsæ™‚ç‚¹ã§ã‚³ãƒ¼ãƒŠãƒ¼ä¸­ï¼‰';
        break;

      // â”€â”€ NEW: phase>=2 & corner==0 â”€â”€
      case 'phase2_straight':
        // fires when horse enters a straight during final phase
        // if fs >= ls: fires at fs (final straight starts after ls)
        // if fs < ls:  horse is already in the final straight â†’ fires at ls? Unlikely for acceleration.
        //              More likely: fires at ls if ls is in a straight
        if (fs == null)
          return {valid:true, cls:'b-rand', label:'ã‚³ãƒ¼ã‚¹æƒ…å ±ä¸è¶³ï¼ˆfsæœªå…¥åŠ›ï¼‰', pri:50};
        fp = (fs >= ls) ? fs : ls;
        suffix = (fs >= ls) ? 'ï¼ˆæœ€çµ‚ç›´ç·šå…¥å£ï¼‰' : 'ï¼ˆlsæ™‚ç‚¹ã§ç›´ç·šä¸­ï¼‰';
        break;

      // â”€â”€ NEW: phase>=2 & corner==0 & straight_front_type==2 (å‘ã“ã†æ­£é¢) â”€â”€
      case 'phase2_front_straight':
        // å‘ã“ã†æ­£é¢ = the far straight (before the final corner)
        // If ls < fc: final phase starts in the far straight â†’ fires at ls
        // If ls >= fc: horse passed the far straight already â†’ skill doesn't fire in phase2
        if (fc == null)
          return {valid:true, cls:'b-rand', label:'ã‚³ãƒ¼ã‚¹æƒ…å ±ä¸è¶³ï¼ˆfcæœªå…¥åŠ›ï¼‰', pri:50};
        if (ls < fc) {
          fp = ls;
          suffix = 'ï¼ˆå‘ã“ã†æ­£é¢ãƒ»çµ‚ç›¤å…¥å£ï¼‰';
        } else {
          // Far straight was traversed in earlier phase
          return {valid:false, cls:'b-inv', label:'ä¸ç™ºï¼ˆå‘ã“ã†æ­£é¢ãŒçµ‚ç›¤å‰ã«é€šéæ¸ˆï¼‰', pri:94};
        }
        break;

      // â”€â”€ NEW: phase>=2 & corner!=0 & is_finalcorner==0 (éæœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼) â”€â”€
      case 'phase2_corner_nonfinal':
        // Fires at first non-final corner in the final phase
        // Very course-specific â€” approximate as "random in phase2 corners"
        return {valid:true, cls:'b-rand', label:'ã‚³ãƒ¼ã‚¹ä¾å­˜ï¼ˆçµ‚ç›¤ã®éæœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼ï¼‰', pri:24};

      default:
        return null;
    }

    if (fp == null) return null;
    return judgeOffset(fp - ls, suffix);
  }

  // â”€â”€ Slope â”€â”€
  if (tm.type === 'slope_up') {
    if (!us || !us.length) return {valid:true, cls:'b-rand', label:'â›° ä¸Šã‚Šå‚ï¼ˆå‚åŒºé–“æœªå…¥åŠ›ï¼‰', pri:40};
    const hit = us.some(([s,e]) => ls>=s && ls<=e);
    return hit
      ? {valid:true,  cls:'b-slope',  label:'â›° ä¸Šã‚Šå‚ï¼ˆæœ‰åŠ¹ï¼‰', pri:10}
      : {valid:false, cls:'b-slopex', label:'â›° ä¸Šã‚Šå‚ï¼ˆç„¡åŠ¹ï¼‰', pri:92};
  }
  if (tm.type === 'slope_down') {
    if (!ds || !ds.length) return {valid:true, cls:'b-rand', label:'â¬‡ ä¸‹ã‚Šå‚ï¼ˆå‚åŒºé–“æœªå…¥åŠ›ï¼‰', pri:41};
    const hit = ds.some(([s,e]) => ls>=s && ls<=e);
    return hit
      ? {valid:true,  cls:'b-slope',  label:'â¬‡ ä¸‹ã‚Šå‚ï¼ˆæœ‰åŠ¹ï¼‰', pri:11}
      : {valid:false, cls:'b-slopex', label:'â¬‡ ä¸‹ã‚Šå‚ï¼ˆç„¡åŠ¹ï¼‰', pri:93};
  }
  if (tm.type === 'slope_up_later_half') {
    if (!us || !us.length) return {valid:true, cls:'b-rand', label:'â›° ä¸Šã‚Šå‚ãƒ»å¾ŒåŠï¼ˆæœªå…¥åŠ›ï¼‰', pri:40};
    const lsHit = us.some(([s,e]) => ls>=s && ls<=e);
    if (lsHit) return {valid:true, cls:'b-slope', label:'â›° ä¸Šã‚Šå‚ãƒ»å¾ŒåŠï¼ˆæœ‰åŠ¹ï¼‰', pri:10};
    const otherHit = us.some(([s,e]) => e>ls);
    if (otherHit) return {valid:true, cls:'b-rand', label:'â›° ä¸Šã‚Šå‚ãƒ»å¾ŒåŠï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰', pri:25};
    return {valid:false, cls:'b-slopex', label:'â›° ä¸Šã‚Šå‚ãƒ»å¾ŒåŠï¼ˆç„¡åŠ¹ï¼‰', pri:92};
  }

  // â”€â”€ Random â”€â”€
  if (tm.type === 'random') {
    const sub = tm.subtype;
    const rv = tm.rv;

    if (sub === 'remain_range') {
      const remainAtLs = distance - ls;
      if (remainAtLs >= rv)
        return {valid:true, cls:'b-fast', label:`æœ€é€Ÿç™ºå‹• (lsæ™‚ç‚¹æ®‹ã‚Š${Math.round(remainAtLs)}mâ‰¥${rv}m)`, pri:0};
      const fp = distance - rv;
      const base = judgeOffset(fp - ls);
      base.label = base.label.replace('ç™ºå‹•', `ç™ºå‹• (æ®‹ã‚Š${rv}mæ¡ä»¶)`);
      return base;
    }
    if (sub === 'remain_lte') {
      const fp = distance - rv;
      const base = judgeOffset(fp - ls);
      base.label = base.label.replace('ç™ºå‹•', `ç™ºå‹• (æ®‹ã‚Š${rv}mä»¥ä¸‹)`);
      return base;
    }

    const MAP = {
      fq:                   {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆçµ‚ç›¤å‰Â¼ï¼‰',      pri:20},
      fh:                   {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆçµ‚ç›¤å‰åŠï¼‰',      pri:21},
      phase2:               {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆçµ‚ç›¤å…¨èˆ¬ï¼‰',      pri:22},
      finalcorner_random:   {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆæœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼ï¼‰',  pri:23},
      finalcorner_lh:       {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆæœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼å¾ŒåŠï¼‰',pri:24},
      phase_corner:         {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆçµ‚ç›¤ã‚³ãƒ¼ãƒŠãƒ¼ï¼‰',  pri:23},
      phase_straight:       {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆçµ‚ç›¤ç›´ç·šï¼‰',      pri:24},
      all_corner:           {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆã‚³ãƒ¼ãƒŠãƒ¼ï¼‰',      pri:25},
      straight_random:      {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆç›´ç·šï¼‰',          pri:26},
      after50:              {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆ50%ä»¥é™ï¼‰',        pri:27},
      dist_rate_after:      {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆå¾ŒåŠï¼‰',           pri:27},
      dist_rate_after_rand: {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆå¾ŒåŠï¼‰',           pri:27},
      lh:                   {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆä¸­ç›¤å¾ŒåŠï¼‰',       pri:29},
      phase_latter_straight:{label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆçµ‚ç›¤å¾ŒåŠç›´ç·šï¼‰',   pri:24},
      other:                {label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹ï¼ˆãã®ä»–ï¼‰',          pri:35},
    };
    const info = MAP[sub];
    if (info) return {valid:true, cls:'b-rand', label:info.label, pri:info.pri};
    return {valid:true, cls:'b-rand', label:'ãƒ©ãƒ³ãƒ€ãƒ æœ‰åŠ¹', pri:36};
  }

  return {valid:false, cls:'b-inv', label:'åˆ¤å®šä¸èƒ½', pri:99};
}

function calcResult(s, rc) {
  // Use segs array if available (OR conditions)
  const segs = s.segs || [s.tm];
  let best = null;
  for (const seg of segs) {
    const res = calcSegTiming(seg, rc);
    if (res === null) continue; // excluded segment
    if (best === null || res.pri < best.pri) best = res;
  }
  if (!best) return {valid:false, cls:'b-inv', label:'é™¤å¤–ã‚¹ã‚­ãƒ«', pri:99};
  return best;
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FILTER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function matches(s, dist, dt, gt, gc, mv, tids){
  // exclude ã‚¿ã‚¤ãƒ—ã¯è¡¨ç¤ºã—ãªã„
  // segsãŒã‚ã‚‹å ´åˆã€å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒexcludeãªã‚‰é™¤å¤–
  if(s.segs && s.segs.length > 0) {
    const anyNonExcl = s.segs.some(t => t.type !== 'exclude');
    if(!anyNonExcl) return false;
  } else if(s.tm && s.tm.type==='exclude') return false;
  if(s.dt&&s.dt.length&&!s.dt.includes(dt)) return false;
  if(s.gt&&s.gt.length&&!s.gt.includes(gt)) return false;
  if(s.gc&&s.gc.length&&!s.gc.includes(gc)) return false;
  if(mv!==null&&s.mv&&mv<s.mv) return false;
  if(s.track&&s.track.length&&!s.track.some(t=>tids.includes(t))) return false;
  if(s.cd_ge!=null&&dist<s.cd_ge) return false;
  if(s.cd_le!=null&&dist>s.cd_le) return false;
  if(s.cd_eq&&s.cd_eq.length&&!s.cd_eq.includes(dist)) return false;
  // ãƒ¬ã‚¢åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (rar=4ã¨5ã¯åŒã˜ã€Œå›ºæœ‰ã€ã¨ã—ã¦æ‰±ã†)
  if(rarFilter.size>0){
    const r = s.rar||1;
    const rNorm = (r === 5) ? 4 : r; // 5â†’4ã«æ­£è¦åŒ–
    if(!rarFilter.has(rNorm)) return false;
  }
  return true;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ORDER RANK DISPLAY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function rankDisplay(raw){
  if(!raw) return {cr:'â€”',lr:'â€”'};
  const segs=(raw||'').split('@');
  const cr=new Set(), lr=new Set();
  segs.forEach(seg=>{
    const le=seg.match(/order_rate<=(\d+)/), ge=seg.match(/order_rate>=(\d+)/);
    const ltS=seg.match(/order_rate<(\d+)/), gtS=seg.match(/order_rate>(\d+)/);
    const ord=seg.match(/\border==(\d+)\b/);
    const ordLe=seg.match(/\border<=(\d+)\b/);
    if(ord){ cr.add(ord[1]+'ä½'); lr.add(ord[1]+'ä½'); }
    else if(ordLe){ cr.add(`${ordLe[1]}ä½ä»¥å†…`); lr.add(`${ordLe[1]}ä½ä»¥å†…`); }
    else if(le&&ge){
      const lo=parseInt(ge[1]),hi=parseInt(le[1]);
      cr.add(`${Math.ceil(lo/100*9)}ã€œ${Math.ceil(hi/100*9)}ä½`);
      lr.add(`${Math.ceil(lo/100*12)}ã€œ${Math.ceil(hi/100*12)}ä½`);
    } else if(le){
      const v=parseInt(le[1]);
      cr.add(`${Math.ceil(v/100*9)}ä½ä»¥å†…`); lr.add(`${Math.ceil(v/100*12)}ä½ä»¥å†…`);
    } else if(ge){
      const v=parseInt(ge[1]);
      const c=9-Math.floor(v/100*9), l=12-Math.floor(v/100*12);
      if(c>0) cr.add(c+'ä½ä»¥é™'); if(l>0) lr.add(l+'ä½ä»¥é™');
    } else if(ltS){
      const v=parseInt(ltS[1]);
      const cv=Math.ceil((v-1)/100*9), lv=Math.ceil((v-1)/100*12);
      if(cv>0) cr.add(cv+'ä½ä»¥å†…'); if(lv>0) lr.add(lv+'ä½ä»¥å†…');
    } else if(gtS){
      const v=parseInt(gtS[1]);
      const c=9-Math.floor(v/100*9), l=12-Math.floor(v/100*12);
      if(c>0) cr.add(c+'ä½ä»¥é™'); if(l>0) lr.add(l+'ä½ä»¥é™');
    }
  });
  return {
    cr:[...cr].join(' / ')||'â€”',
    lr:[...lr].join(' / ')||'â€”'
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SEARCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function doSearch(){
  clearErr();
  const dist  = parseInt(document.getElementById('distSel').value)||0;
  const gt    = getSel('gt');
  const gc    = getSel('gc');
  const mv    = mvVal;
  const venue = document.getElementById('venueSel').value;

  let ok=true;
  if(!dist)  { showErr('e-dist','distSel'); ok=false; }
  if(!gt)    { showErr('e-gt',null); ok=false; }
  if(!gc)    { showErr('e-gc',null); ok=false; }
  if(!venue) { showErr('e-venue','venueSel'); ok=false; }
  if(!ok) return;

  const dt = getDistType(dist);
  const tids = VENUE_TRACKS[venue]||[];

  // ã‚³ãƒ¼ã‚¹æƒ…å ±
  const manLS = parseFloat(document.getElementById('manLS').value);
  const manFC = parseFloat(document.getElementById('manFC').value);
  const manFS = parseFloat(document.getElementById('manFS').value);
  const upS   = getSlopes('up');
  const dnS   = getSlopes('dn');

  const preIdx = document.getElementById('presetSel').value;
  const raceBase = preIdx!=='' ? RACES[parseInt(preIdx)] : {};

  const rc = {
    distance: dist,
    ls: !isNaN(manLS) ? manLS : (raceBase.ls||Math.floor(dist*2/3)),
    fc: !isNaN(manFC) ? manFC : (raceBase.fc||null),
    fs: !isNaN(manFS) ? manFS : (raceBase.fs||null),
    us: upS.length ? upS : (raceBase.us||[]),
    ds: dnS.length ? dnS : (raceBase.ds||[]),
    gt, venue, name: raceBase.name||''
  };

  // ãƒ•ã‚£ãƒ«ã‚¿ï¼‹åˆ¤å®š
  const rows=[];
  SKILLS.forEach(s=>{
    if(!matches(s,dist,dt,gt,gc,mv,tids)) return;
    const res=calcResult(s, rc);
    rows.push({...s, res});
  });

  // ã‚½ãƒ¼ãƒˆ: (1)ã‚¿ã‚¤ãƒŸãƒ³ã‚°priæ˜‡é † (2)ä¸ç¢ºå®Ÿæ€§uncæ˜‡é † (3)åŠ¹æœé‡qtyé™é † (4)ã‚¹ã‚­ãƒ«å50éŸ³é †
  rows.sort((a,b)=>{
    if(a.res.pri!==b.res.pri) return a.res.pri-b.res.pri;
    const ua=calcUnc(a), ub=calcUnc(b);
    if(ua!==ub) return ua-ub;
    if((b.qty||0)!==(a.qty||0)) return (b.qty||0)-(a.qty||0);
    return a.n.localeCompare(b.n,'ja');
  });

  const validCnt=rows.filter(r=>r.res.valid).length;
  document.getElementById('resCnt').textContent=validCnt;
  document.getElementById('resTot').textContent=`ï¼ˆå…¨${rows.length}ä»¶ä¸­ï¼‰`;

  // ãƒãƒƒãƒ—
  const chipsEl=document.getElementById('chips');
  chipsEl.innerHTML='';
  const ac=(t)=>{ const d=document.createElement('div'); d.className='chip'; d.textContent=t; chipsEl.appendChild(d); };
  ac(`${dist}mï¼ˆ${DT_LABEL[dt]}ï¼‰`);
  ac(GT_LABEL[gt]);
  ac(GC_LABEL[gc]);
  if(mv) ac(MV_LABEL[mv]);
  ac(`ğŸ“${venue}`);
  if(rc.name) ac(`ğŸŸ${rc.name}`);
  ac(`ls=${rc.ls}m`);
  if(rc.fc) ac(`fc=${rc.fc}m`);
  if(rc.fs) ac(`fs=${rc.fs}m`);

  // è­¦å‘Š
  const needFC=rows.some(r=>r.tm.fixed_point==='finalcorner');
  const needFS=rows.some(r=>r.tm.fixed_point==='finalstraight'||r.tm.subtype==='finalstraight');
  const wb=document.getElementById('warnBox');
  wb.classList.toggle('show',(needFC&&!rc.fc)||(needFS&&!rc.fs));

  render(rows);
}

function render(rows) {
  const container = document.getElementById('resBody');
  if (rows.length === 0) {
    container.innerHTML = '<div class="no-res">è©²å½“ã™ã‚‹ã‚¹ã‚­ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
    return;
  }

  function uncInfo(unc) {
    if (unc === 0) return {cls:'u-zero', label:'ç¢ºå®š'};
    if (unc <= 2)  return {cls:'u-low',  label:'ä½'};
    if (unc <= 4)  return {cls:'u-mid',  label:'ä¸­'};
    if (unc <= 6)  return {cls:'u-high', label:'é«˜'};
    return              {cls:'u-vhigh', label:'æœ€é«˜'};
  }

  const RAR_INFO = {
    1:{label:'ç™½',cls:'rar-w'},2:{label:'é‡‘',cls:'rar-g'},
    3:{label:'å›ºæœ‰ä¸‹',cls:'rar-ub'},4:{label:'å›ºæœ‰',cls:'rar-u'},
    5:{label:'å›ºæœ‰',cls:'rar-u'},6:{label:'é€²åŒ–',cls:'rar-e'},
  };

  const sortExpl = `<div class="sort-bar">
    <span class="sbl">âœ¦ ã‚½ãƒ¼ãƒˆï¼š</span>ç™ºå‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ—©ã„é †
    <span style="color:var(--border2)">â–¶</span> ä¸ç¢ºå®Ÿæ€§ã‚¹ã‚³ã‚¢æ˜‡é †
    <span style="color:var(--border2)">â–¶</span> åŠ¹æœé‡é™é †
    &nbsp;&nbsp;
    <span class="ct-rrw" style="padding:1px 5px;border-radius:3px">é»„</span> ãƒ¬ãƒ¼ã‚¹é‹ã³æ¡ä»¶(å¼±)ï¼ˆ+1ï¼‰
    <span class="ct-rr" style="padding:1px 5px;border-radius:3px">æ©™</span> ãƒ¬ãƒ¼ã‚¹é‹ã³æ¡ä»¶ï¼ˆ+2ï¼‰
    <span class="ct-rv" style="padding:1px 5px;border-radius:3px">èµ¤</span> ãƒ©ãƒ³ãƒ€ãƒ æ¡ä»¶ï¼ˆ+4ï¼‰
  </div>`;

  let html = sortExpl + '<table><thead><tr>'
    + '<th>ã‚¹ã‚­ãƒ«å</th><th>ãƒ¬ã‚¢åº¦</th><th>åŠ¹æœé‡</th>'
    + '<th>åŠ¹æœ / ç™ºå‹•æ¡ä»¶</th><th>é †ä½æ¡ä»¶<br><span style="font-size:8px;color:var(--tx3)">ãƒãƒ£ãƒ³ãƒŸ / LoH</span></th><th>ã‚¿ã‚¤ãƒŸãƒ³ã‚°</th><th>ä¸ç¢ºå®Ÿæ€§</th>'
    + '</tr></thead><tbody>';

  rows.forEach(r => {
    const trCls = r.res.valid ? '' : 'invalid';
    let accValue = '-';
    if (r.qty != null) accValue = (r.qty / 10000).toFixed(2);
    const ri = RAR_INFO[r.rar] || {label:'?', cls:'rar-w'};
    const unc = calcUnc(r);
    const ui = uncInfo(unc);
    const rr = r.rr || [];
    const rv = r.rv || [];

    let condHtml = '';
    if (rr.length || rv.length) {
      let tags = '';
      rr.forEach(v => {
        if (FIXED_RR_VARS.has(v)) {
          // å›ºå®šæ¡ä»¶ã¯ã‚¿ã‚°éè¡¨ç¤ºï¼ˆã‚¹ã‚³ã‚¢Â±0ï¼‰
        } else if (RR_WEAK_VARS.has(v)) {
          tags += `<span class="cond-tag ct-rrw">${v}</span>`;
        } else {
          tags += `<span class="cond-tag ct-rr">${v}</span>`;
        }
      });
      rv.forEach(v => { if (!FIXED_RV_VARS.has(v)) tags += `<span class="cond-tag ct-rv">${v}</span>`; });
      if (tags) condHtml = '<div class="cond-tags">' + tags + '</div>';
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åè¡¨ç¤º (rar 3-6)
    let charaHtml = '';
    if (r.rar >= 3) {
      const charNames = SKILL_CHARA[r.n];
      if (charNames && charNames.length > 0) {
        charaHtml = `<div class="c-chara">ï¼œ${charNames.join(' / ')}ï¼</div>`;
      }
    }

    // é †ä½æ¡ä»¶è¡¨ç¤º
    const rankHasOrder = /\border(?:_rate)?[=<>!]/.test(r.raw || '');
    let rankHtml = 'â€”';
    if (rankHasOrder) {
      const rd = rankDisplay(r.raw);
      if (rd.cr !== 'â€”' || rd.lr !== 'â€”') {
        rankHtml = `<span class="rank-cr">${rd.cr}</span><span class="rank-sep"> / </span><span class="rank-lr">${rd.lr}</span>`;
      }
    }

    html += `<tr class="${trCls}">
      <td><div class="c-name">${r.n}</div></td>
      <td style="text-align:center"><span class="rar-badge ${ri.cls}">${ri.label}</span></td>
      <td style="text-align:center;font-family:'Share Tech Mono',monospace;color:var(--cyan);font-weight:bold">${accValue}</td>
      <td><div class="c-eff">${r.e}</div>${charaHtml}</td>
      <td class="c-rank">${rankHtml}</td>
      <td><span class="badge ${r.res.cls}">${r.res.label}</span></td>
      <td>
        <span class="unc-badge ${ui.cls}"><span class="unc-score">${unc}</span><span>${ui.label}</span></span>
        ${condHtml}
      </td>
    </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESET
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetAll(){
  document.getElementById('presetSel').value='';
  document.getElementById('distSel').value='';
  document.getElementById('venueSel').value='';
  ['manLS','manFC','manFS'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('upRows').innerHTML='';
  document.getElementById('dnRows').innerHTML='';
  uCnt=0; dCnt=0;
  mvVal=null;
  rarFilter = new Set();
  document.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));
  document.getElementById('chips').innerHTML='';
  document.getElementById('resCnt').textContent='â€”';
  document.getElementById('resTot').textContent='';
  document.getElementById('warnBox').classList.remove('show');
  clearErr();
  document.getElementById('resBody').innerHTML=`<div class="empty">
<div class="empty-icon">ğŸ‡</div>
<p><b>è·é›¢ãƒ»ãƒå ´ãƒ»ãƒå ´çŠ¶æ…‹ãƒ»ãƒ¬ãƒ¼ã‚¹å ´</b>ã‚’é¸æŠã—ã¦<br>æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
</div>`;
}
</script>
</body>
</html>
